<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Font Sharer - Admin Panel</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. Variables & Reset --- */
        :root { 
            --primary-color: #3b82f6; 
            --primary-hover: #2563eb;
            --success-color: #22c55e; 
            --danger-color: #ef4444; 
            --warning-color: #f59e0b;
            --bg-dark-1: #0D1117; 
            --bg-dark-2: #161B22; 
            --bg-dark-3: #21262D;
            --border-color: #30363d;
            --text-primary: #c9d1d9; 
            --text-secondary: #8b949e;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-dark-1);
            color: var(--text-primary);
            overflow: hidden; 
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark-1); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* --- 2. Layout Structure --- */
        .dashboard-layout { display: flex; height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--bg-dark-2);
            border-right: 1px solid var(--border-color);
            padding: 24px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .sidebar.collapsed { width: 80px; padding: 24px 12px; }

        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .logo-container { display: flex; align-items: center; gap: 12px; overflow: hidden; }
        .logo { 
            width: 32px; height: 32px; 
            background: linear-gradient(45deg, #3b82f6, #60a5fa); 
            border-radius: 8px; color: white; 
            display: grid; place-items: center; 
            font-weight: bold; font-size: 1.25rem; 
            flex-shrink: 0; 
        }
        .sidebar-header h1 { font-size: 1.25rem; font-weight: 600; margin: 0; white-space: nowrap; }
        
        .mobile-menu-toggle { display: none; cursor: pointer; font-size: 1.2rem; color: var(--text-secondary); }

        /* Nav */
        .nav-menu { flex-grow: 1; overflow-y: auto; overflow-x: hidden; }
        .nav-list { list-style: none; padding: 0; margin: 0; }
        .nav-item { margin-bottom: 4px; }

        .nav-item a { 
            display: flex; align-items: center; gap: 12px; 
            padding: 12px 16px; 
            border-radius: 6px; 
            text-decoration: none; 
            color: var(--text-secondary); 
            font-weight: 500; 
            transition: all 0.2s; 
            white-space: nowrap; 
        }

        .nav-item a:hover { background-color: var(--bg-dark-3); color: white; }
        .nav-item a.active { background-color: var(--primary-color); color: white; }
        .nav-item a i { width: 20px; text-align: center; flex-shrink: 0; }

        .sidebar.collapsed .logo-container h1, 
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar.collapsed .nav-item a { justify-content: center; padding: 12px; }

        .sidebar-footer { margin-top: auto; padding-top: 10px; }
        #sidebarToggle { 
            width: 100%; background: var(--bg-dark-3); 
            border: none; color: var(--text-secondary); 
            padding: 10px; border-radius: 6px; cursor: pointer; 
        }

        /* Main Content */
        .main-content { flex-grow: 1; padding: 32px; overflow-y: auto; display: flex; flex-direction: column; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; }

        /* Tabs */
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 3. Grid & Components --- */
        .command-center-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            align-items: start;
        }

        .card { 
            background-color: var(--bg-dark-2); 
            border-radius: 8px; 
            border: 1px solid var(--border-color); 
            padding: 24px; 
            display: flex; flex-direction: column; 
            height: 100%;
        }

        .card-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 16px; padding-bottom: 16px; 
            border-bottom: 1px solid var(--border-color); 
        }
        .card-header h3 { margin: 0; font-size: 1.1rem; display: flex; gap: 8px; align-items: center; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .stat-card { background-color: var(--bg-dark-3); padding: 16px; border-radius: 8px; text-align: center; }
        .stat-card .value { font-size: 1.5rem; font-weight: 700; color: white; }
        .stat-card .label { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }

        /* Charts */
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* Lists */
        .item-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; max-height: 400px; }
        .item-list li { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid var(--border-color); 
        }
        .item-info { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 10px; }
        .btn-group { display: flex; gap: 8px; flex-shrink: 0; }

        /* Tables */
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .user-list-table { width: 100%; min-width: 600px; border-collapse: collapse; }
        .user-list-table th, .user-list-table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); }
        .user-list-table th { color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; }

        /* Form Elements */
        .controls { display: flex; gap: 10px; margin-top: 12px; }
        input, select, textarea { 
            width: 100%; padding: 10px; 
            background: var(--bg-dark-1); border: 1px solid var(--border-color); 
            border-radius: 6px; color: white; outline: none; font-family: inherit;
        }
        input:focus { border-color: var(--primary-color); }
        textarea { resize: vertical; min-height: 80px; }

        /* Buttons */
        .action-btn { 
            padding: 8px 16px; border: none; border-radius: 4px; 
            cursor: pointer; color: white; font-size: 0.85rem; 
            transition: opacity 0.2s; white-space: nowrap; 
        }
        .action-btn:hover { opacity: 0.9; }
        .bg-primary { background: var(--primary-color); }
        .bg-success { background: var(--success-color); }
        .bg-danger { background: var(--danger-color); }
        .bg-warning { background: var(--warning-color); color: #000; }
        .bg-secondary { background: var(--border-color); color: var(--text-secondary); }

        /* Logs */
        .log-container { 
            height: 350px; overflow-y: auto; 
            background: #000; padding: 10px; 
            border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
            border: 1px solid var(--border-color);
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-warn { color: var(--warning-color); }
        .log-error { color: var(--danger-color); }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; background: var(--bg-dark-3); border-left: 4px solid var(--primary-color); color: white; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s forwards; }
        .toast-success { border-color: var(--success-color); }
        .toast-error { border-color: var(--danger-color); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- 4. Mobile Responsiveness --- */
        @media (max-width: 768px) {
            .dashboard-layout { flex-direction: column; overflow: hidden; }
            
            .sidebar { 
                width: 100%; height: auto; max-height: 70px;
                padding: 15px 20px;
                overflow: hidden;
            }

            .sidebar.mobile-open { 
                max-height: 100vh; 
                position: absolute; 
                top: 0; left: 0; bottom: 0;
                background: var(--bg-dark-2);
                overflow-y: auto;
            }

            .mobile-menu-toggle { display: block; }
            .sidebar-footer { display: none; }
            
            .sidebar.collapsed { width: 100%; padding: 15px 20px; }
            .sidebar.collapsed .logo-container h1 { display: block; }

            .main-content { padding: 16px; margin-top: 70px; height: calc(100vh - 70px); }
            .command-center-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo">B</div>
                    <h1>Admin Panel</h1>
                </div>
                <div class="mobile-menu-toggle" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </div>
            </div>

            <nav class="nav-menu">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-tab="dashboard">
                            <i class="fas fa-home"></i><span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="users">
                            <i class="fas fa-users"></i><span class="nav-text">Users</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="fonts">
                            <i class="fas fa-font"></i><span class="nav-text">Fonts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="analytics">
                            <i class="fas fa-chart-line"></i><span class="nav-text">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="monitoring">
                            <i class="fas fa-server"></i><span class="nav-text">Monitoring</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="security">
                            <i class="fas fa-shield-alt"></i><span class="nav-text">Security</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <button id="sidebarToggle"><i class="fas fa-chevron-left"></i></button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <h2 id="pageTitle">Dashboard</h2>
                <div id="statusIndicator" style="font-size: 0.9rem; color: var(--text-secondary);">
                    <i class="fas fa-circle" style="font-size: 0.6rem; color: var(--success-color);"></i> Live
                </div>
            </header>
            
            <!-- TAB: DASHBOARD -->
            <div id="dashboard" class="tab-content active">
                <div class="command-center-grid">
                    <!-- Column 1 -->
                    <div class="column">
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-chart-pie"></i> Overview</h3></div>
                            <div class="stats-grid">
                                <div class="stat-card"><div class="value" id="statFonts">0</div><div class="label">Fonts</div></div>
                                <div class="stat-card"><div class="value" id="statUsers">0</div><div class="label">Users</div></div>
                                <div class="stat-card"><div class="value" id="statPending">0</div><div class="label">Pending</div></div>
                                <div class="stat-card"><div class="value" id="statBanned">0</div><div class="label">Banned</div></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-bullhorn"></i> Broadcast</h3></div>
                            <textarea id="broadcastMsg" placeholder="Message to all users..."></textarea>
                            <div class="controls" style="justify-content: flex-end;">
                                <button id="btnBroadcast" class="action-btn bg-primary">Send</button>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2 -->
                    <div class="column">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-clock"></i> Pending Fonts <span id="pendingBadge" class="count" style="font-size: 0.8rem; background: var(--primary-color); padding: 2px 8px; border-radius: 10px;">0</span></h3>
                            </div>
                            <ul class="item-list" id="pendingList">
                                <li style="justify-content: center; color: var(--text-secondary);">Loading...</li>
                            </ul>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3><i class="fas fa-ban"></i> Banned Users</h3></div>
                            <ul class="item-list" id="bannedList">
                                <li style="justify-content: center; color: var(--text-secondary);">Loading...</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Column 3 -->
                    <div class="column">
                        <div class="card" style="min-height: 400px;">
                            <div class="card-header"><h3><i class="fas fa-terminal"></i> System Logs</h3></div>
                            <div class="controls" style="margin-top: 0; margin-bottom: 10px;">
                                <input type="text" id="logFilter" placeholder="Filter logs...">
                            </div>
                            <div id="logContainer" class="log-container">
                                <div class="log-entry" style="color: var(--text-secondary);">Connecting to log stream...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: USERS -->
            <div id="users" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-users"></i> User Directory</h3>
                    </div>
                    <div class="controls">
                        <input type="text" id="userSearch" placeholder="Search ID, Name, Username...">
                        <button id="btnSearchUser" class="action-btn bg-secondary">Search</button>
                    </div>
                    <div class="table-responsive" style="margin-top: 20px;">
                        <table class="user-list-table">
                            <thead><tr><th>ID</th><th>Name</th><th>Username</th><th>Last Seen</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="userTableBody">
                                <!-- Dynamic -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: FONTS -->
            <div id="fonts" class="tab-content">
                <div class="command-center-grid" style="grid-template-columns: 300px 1fr;">
                    <div class="card">
                        <div class="card-header"><h3>Filters</h3></div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <input type="text" id="fontSearchInput" placeholder="Font Name...">
                            <select id="fontCategoryInput"><option value="">All Categories</option><option value="Serif">Serif</option><option value="Sans">Sans</option></select>
                            <button id="btnFilterFonts" class="action-btn bg-primary">Apply</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Font Library</h3></div>
                        <div id="fontGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ANALYTICS -->
            <div id="analytics" class="tab-content">
                <div class="command-center-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card">
                        <div class="card-header"><h3>User Growth</h3></div>
                        <div class="chart-container">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Downloads</h3></div>
                        <div class="chart-container">
                            <canvas id="downloadsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TAB: MONITORING -->
            <div id="monitoring" class="tab-content">
                <div class="command-center-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card">
                        <div class="card-header"><h3>System Load</h3></div>
                        <div class="chart-container">
                            <canvas id="systemMetricsChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Metrics</h3></div>
                        <div class="stats-grid">
                            <div class="stat-card"><div class="value" id="metricCpu">0%</div><div class="label">CPU</div></div>
                            <div class="stat-card"><div class="value" id="metricRam">0MB</div><div class="label">RAM</div></div>
                            <div class="stat-card"><div class="value" id="metricUptime">0%</div><div class="label">Uptime</div></div>
                            <div class="stat-card"><div class="value" id="metricLatency">0ms</div><div class="label">Latency</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: SECURITY -->
            <div id="security" class="tab-content">
                <div class="command-center-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="card">
                        <div class="card-header"><h3>IP Blocking</h3></div>
                        <div class="controls">
                            <input type="text" id="ipInput" placeholder="IP Address">
                            <button id="btnBlockIp" class="action-btn bg-danger">Block</button>
                        </div>
                        <div style="margin-top: 20px; color: var(--text-secondary);" id="blockedIpList">No blocked IPs.</div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Audit Log</h3></div>
                        <div class="log-container" id="auditLogContainer" style="height: 200px;">
                            <div class="log-entry">Loading logs...</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- 1. Utilities ---
        const $ = (id) => document.getElementById(id);
        const $$ = (sel) => document.querySelectorAll(sel);
        const showToast = (msg, type = 'success') => {
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.innerText = msg;
            $('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3500);
        };

        // --- 2. Real API Handler ---
        const apiCall = async (url, method = 'GET', body = null) => {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);

                const res = await fetch(url, options);
                
                // Handle non-JSON responses gracefully
                const contentType = res.headers.get("content-type");
                let data;
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await res.json();
                } else {
                    data = { success: res.ok, message: await res.text() };
                }

                if (!res.ok) throw new Error(data.error || data.message || `API Error: ${res.statusText}`);
                return data;
            } catch (e) {
                console.error(e);
                showToast(e.message, 'error');
                return null;
            }
        };

        // --- 3. UI Renderers ---
        const renderDashboard = (data) => {
            if (!data || !data.stats) return;

            // Stats
            $('statFonts').innerText = data.stats.totalFonts || 0;
            $('statUsers').innerText = data.stats.totalUsers || 0;
            $('statPending').innerText = data.stats.pendingCount || 0;
            $('statBanned').innerText = data.stats.bannedCount || 0;
            $('pendingBadge').innerText = data.stats.pendingCount || 0;

            // Pending List
            const pList = $('pendingList');
            if(data.pendingFonts && data.pendingFonts.length > 0) {
                pList.innerHTML = data.pendingFonts.map(f => `
                    <li>
                        <div class="item-info"><strong>${f.split('_').pop()}</strong></div>
                        <div class="btn-group">
                            <button class="action-btn bg-success" onclick="handleAction('approve', '${f}')"><i class="fas fa-check"></i></button>
                            <button class="action-btn bg-danger" onclick="handleAction('reject', '${f}')"><i class="fas fa-times"></i></button>
                        </div>
                    </li>
                `).join('');
            } else {
                pList.innerHTML = `<li style="justify-content: center; color: var(--text-secondary);">No pending items</li>`;
            }

            // Banned List
            const bList = $('bannedList');
            if(data.bannedUsers && data.bannedUsers.length > 0) {
                bList.innerHTML = data.bannedUsers.map(u => `
                    <li>
                        <div class="item-info">ID: ${u.id} (${u.reason || 'N/A'})</div>
                        <button class="action-btn bg-secondary" onclick="handleAction('unban', ${u.id})">Unban</button>
                    </li>
                `).join('');
            } else {
                bList.innerHTML = `<li style="justify-content: center; color: var(--text-secondary);">No banned users</li>`;
            }

            // Logs
            if(data.logs) {
                const logCont = $('logContainer');
                logCont.innerHTML = data.logs.map(l => `<div class="log-entry">${l}</div>`).join('');
            }
        };

        const renderUserList = (users) => {
            const tbody = $('userTableBody');
            if (!users || users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center">No users found</td></tr>`;
                return;
            }
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.first_name || '-'}</td>
                    <td>${u.username || '-'}</td>
                    <td>${u.lastSeen ? new Date(u.lastSeen).toLocaleDateString() : '-'}</td>
                    <td style="color: ${u.isBanned ? 'var(--danger-color)' : 'var(--success-color)'}">
                        ${u.isBanned ? 'Banned' : 'Active'}
                    </td>
                    <td>
                        <button class="action-btn ${u.isBanned ? 'bg-secondary' : 'bg-danger'}" 
                                onclick="handleAction('${u.isBanned ? 'unban' : 'ban'}', ${u.id})">
                            ${u.isBanned ? 'Unban' : 'Ban'}
                        </button>
                    </td>
                </tr>
            `).join('');
        };

        const renderFonts = (fonts) => {
            const grid = $('fontGrid');
            if (!fonts || fonts.length === 0) {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 20px;">No fonts found</div>`;
                return;
            }
            grid.innerHTML = fonts.map(f => `
                <div style="background: var(--bg-dark-3); padding: 16px; border-radius: 6px;">
                    <div style="font-weight:600; margin-bottom:4px; overflow:hidden; text-overflow:ellipsis;">${f.name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">
                        Size: ${f.size}<br>
                        Downloads: ${f.downloads}
                    </div>
                    <button class="action-btn bg-danger" style="width: 100%;" onclick="deleteFont('${f.name}')">Delete</button>
                </div>
            `).join('');
        };

        // --- 4. Actions ---
        window.handleAction = async (action, id) => {
            if(action === 'ban') {
                const reason = prompt("Reason for ban:");
                if(!reason) return;
                await apiCall(`/api/ban`, 'POST', { userId: id, reason });
            } else if (action === 'unban') {
                await apiCall(`/api/unban`, 'POST', { userId: id });
            } else if (action === 'approve') {
                await apiCall(`/api/approve`, 'POST', { fileName: id });
            } else if (action === 'reject') {
                await apiCall(`/api/reject`, 'POST', { fileName: id });
            }
            showToast(`${action} processed`);
            refreshData(); // Refresh dashboard
        };

        window.deleteFont = async (name) => {
            if(!confirm(`Delete ${name}?`)) return;
            const res = await apiCall(`/api/fonts/${encodeURIComponent(name)}`, 'DELETE');
            if(res) {
                showToast('Font deleted');
                loadTab('fonts');
            }
        };

        const refreshData = async () => {
            const data = await apiCall('/api/data');
            renderDashboard(data);
        };

        const loadTab = async (tab) => {
            if (tab === 'dashboard') refreshData();
            if (tab === 'users') {
                const q = $('userSearch').value;
                const data = await apiCall(`/api/users?search=${q}`);
                if(data) renderUserList(data.users);
            }
            if (tab === 'fonts') {
                const q = $('fontSearchInput').value;
                const cat = $('fontCategoryInput').value;
                const data = await apiCall(`/api/fonts?search=${q}&category=${cat}`);
                if(data) renderFonts(data.fonts);
            }
            if (tab === 'analytics') initCharts();
            if (tab === 'monitoring') updateMonitoring();
        };

        // --- 5. Charts & Monitoring ---
        let chartInstances = {};

        const initCharts = async () => {
            // Fetch real data for charts
            const data = await apiCall('/api/analytics');
            if(!data) return;

            const commonOpts = { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#8b949e' } } },
                scales: { 
                    y: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } },
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } }
                }
            };

            const ctx1 = $('userGrowthChart').getContext('2d');
            if(chartInstances.growth) chartInstances.growth.destroy();
            chartInstances.growth = new Chart(ctx1, {
                type: 'line',
                data: data.userGrowth || { labels: [], datasets: [] }, // Expects backend data structure
                options: commonOpts
            });

            const ctx2 = $('downloadsChart').getContext('2d');
            if(chartInstances.downloads) chartInstances.downloads.destroy();
            chartInstances.downloads = new Chart(ctx2, {
                type: 'bar',
                data: data.downloads || { labels: [], datasets: [] },
                options: commonOpts
            });
        };

        const updateMonitoring = async () => {
            const data = await apiCall('/api/monitoring');
            if(!data) return;
            $('metricCpu').innerText = data.cpu || '0%';
            $('metricRam').innerText = data.ram || '0MB';
            $('metricUptime').innerText = data.uptime || '0%';
            $('metricLatency').innerText = data.latency || '0ms';
            
            // Re-render system chart if needed
            const ctx = $('systemMetricsChart').getContext('2d');
            if(chartInstances.system) chartInstances.system.destroy();
            chartInstances.system = new Chart(ctx, {
                type: 'line',
                data: data.chartData || { labels: [], datasets: [] },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0, max: 100 } }
                }
            });
        };

        // --- 6. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation
            $$('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    $('sidebar').classList.remove('mobile-open');

                    $$('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    $$('.tab-content').forEach(tc => tc.classList.remove('active'));
                    const tabId = link.dataset.tab;
                    $(tabId).classList.add('active');
                    $('pageTitle').innerText = link.querySelector('.nav-text').innerText;

                    loadTab(tabId);
                });
            });

            // Toggles
            $('sidebarToggle').addEventListener('click', () => {
                $('sidebar').classList.toggle('collapsed');
                const icon = $('sidebarToggle').querySelector('i');
                icon.className = $('sidebar').classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
            });
            $('mobileMenuBtn').addEventListener('click', () => $('sidebar').classList.toggle('mobile-open'));

            // Buttons
            $('btnBroadcast').addEventListener('click', async () => {
                const msg = $('broadcastMsg').value;
                if(msg) {
                    await apiCall('/api/broadcast', 'POST', { message: msg });
                    showToast('Broadcast Sent');
                    $('broadcastMsg').value = '';
                }
            });
            
            $('btnSearchUser').addEventListener('click', () => loadTab('users'));
            $('btnFilterFonts').addEventListener('click', () => loadTab('fonts'));
            
            // Security
            $('btnBlockIp').addEventListener('click', async () => {
                const ip = $('ipInput').value;
                if(ip) {
                    await apiCall('/api/security/block', 'POST', { ip });
                    showToast('IP Blocked');
                    $('ipInput').value = '';
                }
            });

            // Initial Data Load
            refreshData();
        });
    </script>
</body>
</html>